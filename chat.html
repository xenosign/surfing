<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
  </head>
  <body>
    <h2>ì±Œë¦°ì§€ ì±„íŒ…ë°© í…ŒìŠ¤íŠ¸</h2>
    <p>í˜„ì¬ ì±„íŒ…ë°©: ì±Œë¦°ì§€ <span id="challengeIdDisplay">?</span>ë²ˆ</p>

    <label>ìœ ì € ID: <input type="text" id="userId" value="100" /></label>
    <label>ì±Œë¦°ì§€ ID: <input type="text" id="challengeId" value="1" /></label>
    <button onclick="connect()">ì—°ê²°</button>
    <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>

    <br /><br />

    <div>í˜„ì¬ ì ‘ì†ì: <span id="userCount">0</span>ëª…</div>

    <br />

    <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="sendMessage()">ì „ì†¡</button>

    <hr />
    <h4>ë©”ì‹œì§€ ë¡œê·¸:</h4>
    <div
      id="chat"
      style="
        white-space: pre-line;
        border: 1px solid #ccc;
        padding: 10px;
        width: 90%;
        height: 300px;
        overflow-y: scroll;
      "
    ></div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
      let stompClient = null;
      let subscription = null;

      function connect() {
        const socket = new SockJS('http://localhost:8080/ws/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
          const userId = document.getElementById('userId').value;
          const challengeId = document.getElementById('challengeId').value;
          document.getElementById('challengeIdDisplay').textContent =
            challengeId;

          // ë©”ì‹œì§€ êµ¬ë…
          subscription = stompClient.subscribe(
            '/topic/chat/' + challengeId,
            function (message) {
              const msg = JSON.parse(message.body);
              console.log('ë°›ì€ ë©”ì‹œì§€:', msg);
              showMessage(msg);
            }
          );

          // ì ‘ì†ì ìˆ˜ êµ¬ë… ì¶”ê°€
          stompClient.subscribe(
            '/topic/userCount/' + challengeId,
            function (message) {
              const count = JSON.parse(message.body);
              document.getElementById('userCount').textContent = count;
            }
          );

          // ì…ì¥ ì•Œë¦¼
          stompClient.send(
            '/app/chat/' + challengeId + '/join',
            {},
            JSON.stringify({
              userId: userId,
              challengeId: challengeId,
              messageType: 'ENTER',
            })
          );
        });
      }

      function disconnect() {
        if (stompClient && stompClient.connected) {
          console.log('ì—°ê²° í•´ì œ ì¤‘...');
          stompClient.disconnect(function () {
            console.log('ì—°ê²° í•´ì œ ì™„ë£Œ');
          });
        }
      }

      function sendMessage() {
        const userId = document.getElementById('userId').value;
        const challengeId = document.getElementById('challengeId').value;
        const message = document.getElementById('messageInput').value;

        if (message.trim() === '') return;

        stompClient.send(
          '/app/chat/' + challengeId + '/send',
          {},
          JSON.stringify({
            userId: userId,
            challengeId: challengeId,
            message: message,
            messageType: 'MESSAGE',
          })
        );
        document.getElementById('messageInput').value = '';
      }

      function showMessage(msg) {
        const chatDiv = document.getElementById('chat');
        const time = new Date().toLocaleTimeString();
        let log = '[' + time + '] ';

        const messageType = msg.messageType || 'UNKNOWN';
        console.log('ë©”ì‹œì§€ íƒ€ì…:', messageType, 'ì „ì²´ ë©”ì‹œì§€:', msg);

        if (messageType === 'SYSTEM') {
          log += 'ğŸ”” ' + msg.message;
        } else if (messageType === 'ENTER') {
          log += 'ğŸ”” ì‚¬ìš©ì' + msg.userId + 'ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.';
        } else if (messageType === 'LEAVE') {
          log += 'ğŸ‘‹ ì‚¬ìš©ì' + msg.userId + 'ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.';
        } else if (messageType === 'MESSAGE') {
          log += '[' + msg.userName + '] ' + msg.message;
        } else {
          log +=
            '[ì•Œ ìˆ˜ ì—†ëŠ” íƒ€ì…: ' + messageType + '] ' + (msg.message || '');
        }

        chatDiv.textContent += log + '\\n';
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }
    </script>
  </body>
</html>
